<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CIT Capstone Repository</title>
  <link href="/static/icons/favicon.svg" rel="icon">
  <link href="/static/css/bootstrap.min.css" rel="stylesheet">
  <script src="/static/js/bootstrap.bundle.min.js"></script>
</head>
<body>
  <!-- Header Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark shadow" style="background:#80B">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="#">CIT Capstone Repository</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="/manage">Manage Capstones</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="/">Search</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Page Content-->
  <div class="container mt-4">
    <form id="searchForm" class="d-flex mb-3">
      <input class="form-control me-2" type="search" placeholder="Search capstone..." id="searchInput">
      <button class="btn btn-primary"><img src="/static/icons/magnify.svg"></button>
    </form>
    <div id="results"></div>
    <nav>
      <ul class="pagination" id="pagination"></ul>
    </nav>
  </div>
  <script>
    let debounceTimer;
    
    document.getElementById("searchForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const searchQuery = document.getElementById("searchInput").value;
        loadSearch(searchQuery);    
    });

    function debounce(callback, delay=500) {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(callback, delay);
    }

    function truncateText(text, maxWords=30) {
      const words = text.split(" ");
      if (words.length > maxWords) {
        return words.slice(0, maxWords).join(" ") + "...";
      }
      return text;
    }

    async function loadSearch(searchQuery, page=1) {
      if (searchQuery === "") return;
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "Fetching...";

      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";
      
      const res = await fetch(`/search?page=${page}&per_page=5`, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ text: searchQuery })
      });
      
      const data = await res.json();
      resultsDiv.innerHTML = "";
      if (data.results.length === 0) {
        resultsDiv.innerHTML = "No results found.";
        return;
      }
      data.results.forEach(r => {
          const div = document.createElement("div");
          div.classList.add("card", "mb-2", "p-2");
          div.innerHTML = `
              <h5>${r.title}</h5>
              <p>${truncateText(r.abstract)}</p>
              <small>Similarity: ${(r.similarity*100).toFixed(0)}%</small>
          `;
          resultsDiv.appendChild(div);
      });
      
      const totalPages = Math.ceil(data.total / data.per_page);
      pagination.innerHTML = "";
      
      for (let i = 1; i <= totalPages; i++) {
        pagination.innerHTML += `
          <li class="page-item ${i === data.page ? "active" : ""}">
            <button class="page-link" onclick="loadSearch(${i})">${i}</button>
          </li>`;
      }
    }
  </script>
</body>
</html>
